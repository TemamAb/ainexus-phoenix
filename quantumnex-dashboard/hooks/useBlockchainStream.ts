import { useCallback, useEffect, useRef, useState } from 'react'\n\nexport default function useBlockchainStream() {\n  const [events, setEvents] = useState<any[]>([])\n  const wsRef = useRef<WebSocket | null>(null)\n\n  const connect = useCallback(() => {\n    if (wsRef.current) return\n    const url = process.env.NEXT_PUBLIC_WS_ENDPOINT || 'ws://localhost:8546'\n    const ws = new WebSocket(url)\n    ws.onopen = () => console.info('ws open')\n    ws.onmessage = (m) => {\n      try {\n        const d = JSON.parse(m.data as string)\n        setEvents((s) => [d, ...s].slice(0, 200))\n      } catch (e) {\n        console.warn('ws parse', e)\n      }\n    }\n    ws.onclose = () => console.info('ws closed')\n    ws.onerror = (err) => console.error('ws error', err)\n    wsRef.current = ws\n  }, [])\n\n  useEffect(() => {\n    return () => {\n      wsRef.current?.close()\n      wsRef.current = null\n    }\n  }, [])\n\n  return { events, connect }\n}